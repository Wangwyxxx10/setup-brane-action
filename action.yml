name: setup-brane-action
description: setup brane in your actions workflow
author: romnn
branding:
  icon: target
  color: black
inputs:
  start_instance:
    description: starts a brane instance
    required: false
    default: false
  start_ide:
    description: starts a brane IDE
    required: false
    default: false
outputs:
  jupyterlab_token:
    value: ${{ steps.start_brane_ide.outputs.jupyterlab_token }}
runs:
  using: composite
  steps:
    - name: Install the brane CLI
      shell: bash
      id: install_brane_cli
      run: |
        sudo apt-get update
        sudo apt-get install ca-certificates curl gnupg lsb-release
        sudo mkdir -p /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

   

    - name: Download brane source
      shell: bash
      run: |
          git clone --depth 1 https://github.com/epi-project/brane.git
          cp -iv ./brane/contrib/config/infra-local.yml ./brane/infra.yml
          echo "BRANE_SRC=./brane" >> $GITHUB_ENV
          sudo cp ./brane /usr/local/bin/brane

    - name: Start brane instance
      shell: bash
      id: start_brane_instance
      run: |
        if [[ "$START_INSTANCE" == "true" ]] || [[ "$START_IDE" == "true" ]]; then
          chmod +x $BRANE_SRC/make.sh
          $BRANE_SRC/make.sh start-instance
        else
          echo "skipping starting brane instance..."
        fi

    - name: Start brane IDE
      shell: bash
      id: start_brane_ide
      run: |
        if [[ "$START_IDE" == "true" ]]; then
          git clone https://github.com/epi-project/brane-ide.git
          echo "BRANE_IDE_SRC=./brane-ide" >> $GITHUB_ENV
          make -C "$BRANE_IDE__SRC" start-ide
          export JUPYTERLAB_TOKEN=$(make -C "$BRANE_SRC" jupyterlab-token)
          echo "::set-output name=jupyterlab_token::${JUPYTERLAB_TOKEN}"
        else
          echo "skipping starting brane IDE..."
        fi
